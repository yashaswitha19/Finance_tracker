<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Finance Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script> <style>
        body {
            background-color: #f8f9fa; /* Light gray background */
        }

        .main-content {
            margin-left: 280px;
            padding: 1.5rem;
        }

        /* Responsive handling for sidebar */
        @media (max-width: 992px) {
            .main-content {
                margin-left: 0;
            }
        }

        /* Report Specific Styles */
        .filter-card, .table-card, .chart-card, .stat-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem; /* Consistent margin */
        }

        .filter-card { padding: 1.5rem; }
        .table-card { overflow: hidden; } /* Hide overflow for radius */
        .chart-card { padding: 1.5rem; min-height: 400px; /* Chart height */ display: flex; flex-direction: column; }
        .stat-card { padding: 1.5rem; text-align: center; }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Responsive columns */
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card i { font-size: 2rem; margin-bottom: 0.75rem; }
        .stat-label { font-size: 0.9rem; color: #6c757d; margin-bottom: 0.25rem; }
        .stat-value { font-size: 1.5rem; font-weight: 600; }
        .stat-value.income { color: #198754; }
        .stat-value.expense { color: #dc3545; }
        .stat-value.balance { color: #0d6efd; }
        .stat-value.savings { color: #0dcaf0; } /* Info color for savings */

        .table-card-header { padding: 1rem 1.5rem; font-weight: 600; font-size: 1.05rem; color: white; border-bottom: none;}
        .table-card-header.income { background: #198754; }
        .table-card-header.expense { background: #dc3545; }
        .table-card-header.monthly { background: #0d6efd; }

        .table thead th { background-color: #e9ecef; border-bottom-width: 1px; font-weight: 600; padding: 0.75rem 1rem;}
        .table tbody td { padding: 0.75rem 1rem; vertical-align: middle; }

        /* Improved progress bar */
        .progress { height: 20px; font-size: 0.8rem; }
        .progress-bar { font-weight: 500;}

        /* Consistent Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: #6c757d;
            flex-grow: 1; /* For centering in chart cards */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <%- include('partials/sidebar', {Active: 'report',user: user }) %>

    <div class="main-content">
        <div class="container-fluid p-0">
            <h1 class="page-title mb-4">Reports</h1>

            <div class="filter-card">
                <h5 class="mb-3">Filter Transactions</h5>
                <form action="/report" method="POST">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="startDate" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate" name="startDate" value="<%= startDate %>" required>
                        </div>
                        <div class="col-md-3">
                            <label for="endDate" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate" name="endDate" value="<%= endDate %>" required>
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary w-100"><i class="bi bi-funnel me-1"></i> Filter</button>
                        </div>
                        <div class="col-md-4 d-flex align-items-end gap-2 justify-content-end">
                             <button type="button" class="btn btn-outline-success" onclick="exportCSV()">
                                <i class="bi bi-file-earmark-spreadsheet me-1"></i>Export CSV
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="exportPDF()">
                                <i class="bi bi-file-earmark-pdf me-1"></i>Export PDF
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="stats-row">
                <div class="stat-card income">
                    <i class="bi bi-arrow-up-circle"></i>
                    <div class="stat-label">Total Income</div>
                    <div class="stat-value income">₹<%= totalIncome.toLocaleString('en-IN') %></div>
                </div>
                <div class="stat-card expense">
                    <i class="bi bi-arrow-down-circle"></i>
                    <div class="stat-label">Total Expense</div>
                    <div class="stat-value expense">₹<%= totalExpense.toLocaleString('en-IN') %></div>
                </div>
                <div class="stat-card balance">
                    <i class="bi bi-wallet2"></i>
                    <div class="stat-label">Net Balance</div>
                    <div class="stat-value <%= netBalance >= 0 ? 'income' : 'expense' %>">
                        ₹<%= netBalance.toLocaleString('en-IN') %>
                    </div>
                </div>
                <div class="stat-card savings">
                    <i class="bi bi-piggy-bank"></i>
                    <div class="stat-label">Savings Rate</div>
                    <div class="stat-value savings"><%= savingsRate %>%</div>
                </div>
            </div>

            <div class="table-card">
                <div class="table-card-header income">
                    <i class="bi bi-graph-up me-2"></i>Income Report
                </div>
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th># Transactions</th>
                                <th>Total Amount</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (incomeReport.length > 0) { %>
                                <% incomeReport.forEach(item => { %>
                                    <tr>
                                        <td><strong><%= item.category %></strong></td>
                                        <td><%= item.count %></td>
                                        <td class="text-success fw-semibold">₹<%= item.amount.toLocaleString('en-IN') %></td>
                                        <td>
                                            <div class="progress">
                                                <div class="progress-bar bg-success" role="progressbar" style="width: <%= item.percentage %>%">
                                                    <%= item.percentage %>%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="4">
                                        <div class="empty-state">
                                            <i class="bi bi-inbox"></i>
                                            <p>No income transactions found for this period.</p>
                                        </div>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="table-card">
                <div class="table-card-header expense">
                    <i class="bi bi-graph-down me-2"></i>Expense Report by Category
                </div>
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th># Transactions</th>
                                <th>Total Amount</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (expenseReport.length > 0) { %>
                                <% expenseReport.forEach(item => { %>
                                    <tr>
                                        <td><strong><%= item.category %></strong></td>
                                        <td><%= item.count %></td>
                                        <td class="text-danger fw-semibold">₹<%= item.amount.toLocaleString('en-IN') %></td>
                                        <td>
                                            <div class="progress">
                                                <div class="progress-bar bg-danger" role="progressbar" style="width: <%= item.percentage %>%">
                                                    <%= item.percentage %>%
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="4">
                                        <div class="empty-state">
                                            <i class="bi bi-inbox"></i>
                                            <p>No expense transactions found for this period.</p>
                                        </div>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="table-card">
                <div class="table-card-header monthly">
                    <i class="bi bi-calendar-month me-2"></i>Monthly Breakdown
                </div>
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th>Income</th>
                                <th>Expense</th>
                                <th>Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (monthlyBreakdown.length > 0) { %>
                                <% monthlyBreakdown.forEach(item => { %>
                                    <tr>
                                        <td><strong><%= item.month %></strong></td>
                                        <td class="text-success fw-semibold">₹<%= item.income.toLocaleString('en-IN') %></td>
                                        <td class="text-danger fw-semibold">₹<%= item.expense.toLocaleString('en-IN') %></td>
                                        <td class="<%= item.balance >= 0 ? 'text-success' : 'text-danger' %> fw-semibold">
                                            ₹<%= item.balance.toLocaleString('en-IN') %>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="4">
                                        <div class="empty-state">
                                            <i class="bi bi-inbox"></i>
                                            <p>No transactions found for this period.</p>
                                        </div>
                                    </td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-6">
                    <div class="chart-card">
                        <h5 class="mb-3"><i class="bi bi-pie-chart me-2"></i>Top 5 Spending Categories</h5>
                        <% if (topCategories.labels.length > 0) { %>
                            <div class="position-relative flex-grow-1">
                                <canvas id="topCategoriesPieChart"></canvas>
                            </div>
                        <% } else { %>
                            <div class="empty-state">
                                <i class="bi bi-pie-chart"></i>
                                <p>No expense data available</p>
                            </div>
                        <% } %>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="chart-card">
                        <h5 class="mb-3"><i class="bi bi-graph-up me-2"></i>Monthly Balance Trend</h5>
                        <% if (balanceTrend.labels.length > 0) { %>
                             <div class="position-relative flex-grow-1">
                                <canvas id="balanceTrendChart"></canvas>
                             </div>
                        <% } else { %>
                            <div class="empty-state">
                                <i class="bi bi-graph-up"></i>
                                <p>No trend data available</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div> </div> </div> <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false, // Key for filling the card height
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { padding: 15, font: { size: 12 } }
                    }
                }
            };

            // --- TOP 5 SPENDING PIE CHART ---
            <% if (topCategories && topCategories.labels && topCategories.labels.length > 0) { %>
                const pieCtx = document.getElementById('topCategoriesPieChart');
                if (pieCtx) {
                    new Chart(pieCtx, {
                        type: 'pie',
                        data: {
                            labels: <%- JSON.stringify(topCategories.labels) %>,
                            datasets: [{
                                data: <%- JSON.stringify(topCategories.data) %>,
                                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                                borderWidth: 1,
                                borderColor: '#fff'
                            }]
                        },
                        options: { // Specific options for Pie chart tooltip
                            ...chartOptions,
                            plugins: {
                                ...chartOptions.plugins,
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return context.label + ': ₹' + context.parsed.toLocaleString('en-IN');
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            <% } %>

            // --- MONTHLY BALANCE TREND LINE CHART ---
            <% if (balanceTrend && balanceTrend.labels && balanceTrend.labels.length > 0) { %>
                const lineCtx = document.getElementById('balanceTrendChart');
                if (lineCtx) {
                    new Chart(lineCtx, {
                        type: 'line',
                        data: {
                            labels: <%- JSON.stringify(balanceTrend.labels) %>,
                            datasets: [
                                { label: 'Income', data: <%- JSON.stringify(balanceTrend.income) %>, borderColor: '#198754', backgroundColor: 'rgba(25, 135, 84, 0.1)', tension: 0.1, fill: true },
                                { label: 'Expense', data: <%- JSON.stringify(balanceTrend.expense) %>, borderColor: '#dc3545', backgroundColor: 'rgba(220, 53, 69, 0.1)', tension: 0.1, fill: true },
                                { label: 'Balance', data: <%- JSON.stringify(balanceTrend.balance) %>, borderColor: '#0d6efd', backgroundColor: 'rgba(13, 110, 253, 0.1)', tension: 0.1, fill: true }
                            ]
                        },
                        options: { // Specific options for Line chart
                           ...chartOptions,
                           interaction: { mode: 'index', intersect: false },
                           plugins: {
                               ...chartOptions.plugins,
                               tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString('en-IN');
                                        }
                                    }
                                }
                           },
                           scales: {
                                y: {
                                    beginAtZero: false, // Allow negative balance display
                                    ticks: {
                                        callback: function (value) { return '₹' + value.toLocaleString('en-IN'); }
                                    }
                                }
                           }
                        }
                    });
                }
            <% } %>
        });

        // Placeholder functions for export buttons
        function exportCSV() {
            alert('Export to CSV functionality not implemented yet.');
            // Add actual CSV export logic here
        }

        function exportPDF() {
            alert('Export to PDF functionality not implemented yet.');
            // Add actual PDF export logic here (e.g., using jsPDF)
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>